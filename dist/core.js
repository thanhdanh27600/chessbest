(()=>{"use strict";({776:function(){var e=this&&this.__awaiter||function(e,o,a,t){return new(a||(a=Promise))((function(n,l){function s(e){try{r(t.next(e))}catch(e){l(e)}}function i(e){try{r(t.throw(e))}catch(e){l(e)}}function r(e){var o;e.done?n(e.value):(o=e.value,o instanceof a?o:new a((function(e){e(o)}))).then(s,i)}r((t=t.apply(e,o||[])).next())}))};console.log("chessdol: contentScript run");const o=window,a="shared-2706";let t,n,l;const s=(e=a)=>{t=(e=>`fens/${e}`)(e),n=(e=>`fens/${e}/hint`)(e),l=(e=>`fens/${e}/evaluation`)(e)};s();let i={};const r="Offline",d="Game over. Waiting for new game",c="Waiting for new move",u=e=>{o.dolph.popup.status=e,v()},v=()=>{const e=document.getElementById("statusDisplay");e&&(e.value=o.dolph.popup.status,e.dispatchEvent(new Event("input")))},h=e=>o=>{i&&i.get(i.ref(i.db,`servers/${e}`)).then((e=>{e.exists()&&e.val()&&o()})).catch((e=>{console.error(e)}))},f=()=>{const e=setInterval((()=>{u("Waiting for new game");const a=document.getElementsByTagName("chess-board")[0];if(!a)return void console.log("chessdol: Not found Board");u("Waiting for board's game");const s=a.game;if(!s)return void console.log("chessdol: Not found Board Game");u(c),clearInterval(e),o.dolph.game=s,p();const v=e=>{console.log("chessdol: Writing...",e),i.set(i.ref(i.db,t),{fen:e})};if(!v)return void console.log("chessdol: Not found writeUserData");v(s.getFEN()),s.on("Move",(({data:e})=>{if(o.dolph.popup.status===r)return;const a=e.move.fen;console.log("chessdol: curFen Move",a),v(a),o.dolph.beforeFen=a,u("Calculating best move")})),s.on("Load",(({data:e})=>{var a;if(o.dolph.popup.status===r)return;const t=null===(a=e.move)||void 0===a?void 0:a.fen;t&&(console.log("chessdol: curFen Load",t),v(t)),p()}));const h=setInterval((()=>{s.isGameOver()?u(d):o.dolph.hint&&f(o.dolph.hint)}),50),f=e=>{if(!e)return;const a=e.value,t=e.fen;if(a.length<4)return;if(o.dolph.beforeFen!==t)return void console.log(" fen not match");const n=`${a[0]}${a[1]}`,l=`${a[2]}${a[3]}`;s.markings.removeAll(),s.markings.addOne({data:{color:"#96be46",from:n,to:l},type:"arrow"})},m=e=>i.onValue(i.ref(i.db,l),e);m?m((e=>{const a=e.val();console.log("chessdol: Received evaluation",a),setTimeout(b),a&&(o.dolph.evaluationType=a.evaluationType,o.dolph.evaluationValue=a.evaluationValue)})):console.log("chessdol: Not found listener evaluation");const g=e=>i.onValue(i.ref(i.db,n),e);g?g((e=>{const a=e.val();console.log("chessdol: Received hint",a),a&&(o.dolph.hint=a,f(a),s.isGameOver()?u(d):u(c))})):console.log("chessdol: Not found listener hint"),o.dolph.clearAll=()=>{clearInterval(h),s.markings.removeAll(),i.off(i.ref(i.db,n),"value"),i.off(i.ref(i.db,l),"value"),s.on("Move",(({data:e})=>{})),s.on("Load",(({data:e})=>{})),u(r),console.log("chessdol: cleared")}}),500)},p=()=>{const e=document.getElementById("board-layout-evaluation");e?e.innerHTML='<evaluation-bar board-id="board-single" is-default-fen-automatic="true" data-cy="evaluation-bar"" data-dolph="ok" style="flex: 1 1 auto;">\n      <div class="evaluation-bar-bar undefined ">\n        <span class="evaluation-bar-scoreAbbreviated"></span>\n        <span class="evaluation-bar-score"></span>\n        <div class="evaluation-bar-fill">\n          <div class="evaluation-bar-color evaluation-bar-black"></div>\n          <div class="evaluation-bar-color evaluation-bar-draw"></div>\n          <div class="evaluation-bar-color evaluation-bar-white" style="transform: translate3d(0, 50%, 0)"></div>\n        </div>\n      </div>\n    </evaluation-bar>':console.log("chessdol: no evaluation board found")},b=()=>{const e=o.dolph.evaluationType,a=o.dolph.evaluationValue,t=document.getElementsByClassName("evaluation-bar-color evaluation-bar-white")[0],n=document.getElementsByClassName("evaluation-bar-scoreAbbreviated")[0];if(!e||!a)return void console.log("chessdol: no evaluation found");if(!n||!t)return void console.log("chessdol: no evaluation element found");const l=document.getElementsByClassName("evaluation-bar-score")[0],s=+a;s<0?(n.classList.remove("evaluation-bar-dark"),n.classList.add("evaluation-bar-light"),l.classList.remove("evaluation-bar-dark"),l.classList.add("evaluation-bar-light")):(n.classList.remove("evaluation-bar-light"),n.classList.add("evaluation-bar-dark"),l.classList.remove("evaluation-bar-light"),l.classList.add("evaluation-bar-dark"));const i=s/100,r=s,d=parseFloat(i.toFixed(1));if("cp"===e){n.textContent=d+"",l.textContent=`${i>0?"+":""}${i}`;let e=50-5*i;e<0&&(e=10),e>100&&(e=90),t.style=`transform: translate3d(0, ${e}%, 0)`}"mate"===e&&(n.textContent=`M${Math.abs(r)}`,l.textContent=`M${Math.abs(r)}`,t.style=`transform: translate3d(0, ${r<0?100:0}%, 0)`)};o.dolph.popup={status:r},o.dolph.clearAll=()=>{},(()=>{const a=document.createElement("input");a.id="chessdol-key",a.style.display="none",document.body.appendChild(a),a.addEventListener("input",(function(a){return e(this,void 0,void 0,(function*(){const e=this.value;u(r),o.dolph.clearAll(),h(e)((function(){s(e),f()}))}))}))})(),(()=>{const e=setInterval((()=>{o.dolph&&(i=o.dolph.firebase,i&&(console.log("chessdol: firebase connected",i),clearInterval(e),h(a)((function(){f(),u("Connected to chess engine")}))))}),500)})()}})[776]()})();